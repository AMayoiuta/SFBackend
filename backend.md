# SmartFlow 后端开发文档

## 1. 系统架构概述

SmartFlow后端采用现代化的FastAPI框架构建，实现了RESTful API接口，支持异步处理和依赖注入。系统架构主要分为以下几个核心模块：

- **API层**：处理HTTP请求和响应，实现业务逻辑接口
- **核心服务层**：包含认证、配置和AI服务等核心功能
- **数据访问层**：管理数据库连接和ORM模型
- **工具类**：提供通用工具函数和辅助功能

### 1.1 技术栈

- **Web框架**：FastAPI
- **ORM**：SQLAlchemy
- **数据库**：PostgreSQL
- **认证**：JWT令牌
- **API文档**：Swagger/ReDoc（自动生成）
- **异步HTTP客户端**：httpx

## 2. 模块详细分析

### 2.1 API层 (api/)

API层采用分层结构，主要包含v1版本的API端点：

#### 2.1.1 API路由 (api/v1/api.py)

已配置的路由包括：
- `/auth`: 用户认证相关接口
- `/users`: 用户管理接口
- `/tasks`: 任务管理接口
- `/reminders`: 提醒服务接口
- `/reports`: 日报生成接口
- `/chat`: 社群聊天接口

#### 2.1.2 端点实现状态

| 端点模块 | 完成状态 | 待解决问题 |
|---------|---------|-----------|
| auth.py | 未实现 | 需完整实现JWT认证流程 |
| users.py | 未实现 | 需实现用户CRUD操作 |
| tasks.py | 部分实现 | 已有基础框架，但多数端点仅有注释说明 |
| reminders.py | 未实现 | 需开发提醒创建和触发机制 |
| reports.py | 未实现 | 需实现日报生成算法 |
| chat.py | 未实现 | 需实现社群交流功能 |

### 2.2 核心服务层 (core/)

#### 2.2.1 配置管理 (core/config.py)

- 已实现基于Pydantic的配置管理
- 支持环境变量和.env文件加载配置
- 包含数据库、认证、AI服务等配置项

#### 2.2.2 认证服务 (core/auth/)

认证框架已搭建，但缺少具体实现：
- jwt.py: JWT令牌生成和验证（仅有文件结构）
- deps.py: FastAPI依赖项（仅有文件结构）
- password.py: 密码哈希功能（部分实现）

#### 2.2.3 AI服务 (core/ai_services/)

任务拆解AI服务架构已完成，包括：
- 模型API调用封装
- 提示词构建
- 响应解析
- 错误处理机制

### 2.3 数据访问层 (db/)

#### 2.3.1 数据库模型 (db/models.py)

已完整定义以下模型：
- User: 用户信息
- Task: 主任务
- SubTask: 子任务
- TaskLog: 任务执行日志
- Reminder: 提醒设置
- DailyReport: 每日智能日报
- ChatMessage: 社群聊天消息

#### 2.3.2 数据库会话 (db/session.py)

已实现数据库连接和会话管理，包括：
- 数据库引擎配置
- 会话创建和管理
- FastAPI依赖项注入

#### 2.3.3 基础模型 (db/base.py)

实现了所有模型的基类，提供：
- ID自增主键
- 创建和更新时间戳
- 表名自动生成

### 2.4 数据库初始化 (initialize_db.py)

提供了数据库初始化脚本，功能包括：
- 创建数据库表结构
- 添加示例用户和任务数据
- 支持开发环境快速启动

## 3. 系统流程分析

### 3.1 API请求处理流程

1. 客户端发送请求到FastAPI应用
2. 中间件处理CORS和其他前置任务
3. 路由系统分发请求到对应端点
4. 认证依赖项验证用户身份（待实现）
5. 端点函数处理业务逻辑
6. 数据库会话执行CRUD操作
7. 返回处理结果给客户端

### 3.2 认证流程（待实现）

1. 用户登录提交凭据
2. 验证用户名和密码
3. 生成JWT访问令牌
4. 客户端存储令牌
5. 后续请求携带令牌
6. 服务器验证令牌有效性
7. 提取用户信息并授权访问

### 3.3 AI任务拆解流程

1. 接收任务描述
2. 构建AI提示词
3. 调用外部AI模型API
4. 解析返回的JSON数据
5. 创建主任务和子任务
6. 返回拆解结果

## 4. 亟待解决问题

### 4.1 认证系统实现

**优先级：高**

当前状态：仅有文件结构，缺少实际实现。
任务：
- 实现JWT令牌生成和验证
- 完成用户认证路由
- 实现密码哈希和验证
- 连接用户数据库模型
- 集成依赖项到API端点

### 4.2 API端点完善

**优先级：高**

当前状态：大部分端点只有框架，缺少实现。
任务：
- 完成任务管理API (tasks.py)
- 实现用户管理API (users.py)
- 开发提醒系统API (reminders.py)
- 实现日报生成API (reports.py)
- 构建社群聊天API (chat.py)

### 4.3 AI服务集成

**优先级：中**

当前状态：已有基础框架，但未与实际API集成。
任务：
- 配置外部AI模型API密钥
- 测试API连接和响应
- 优化提示词模板
- 完善错误处理机制
- 集成到任务拆解端点

### 4.4 数据库连接配置

**优先级：高**

当前状态：已有配置框架，但可能需要适配实际环境。
任务：
- 确保PostgreSQL连接配置正确
- 验证ORM模型与数据库表映射
- 测试数据库CRUD操作
- 优化查询性能

### 4.5 数据验证和安全性

**优先级：中**

当前状态：缺少输入验证和安全措施。
任务：
- 添加Pydantic模型进行请求验证
- 实现请求速率限制
- 添加日志记录系统
- 实现适当的错误处理

### 4.6 测试覆盖

**优先级：低**

当前状态：缺少自动化测试。
任务：
- 添加单元测试
- 实现API集成测试
- 添加数据库测试
- 配置CI/CD流程

## 5. 实施计划

### 5.1 短期目标（24小时内）

1. 实现认证系统基础功能
   - 完成JWT令牌实现
   - 实现用户认证路由
   - 添加密码哈希功能

2. 完成核心API端点
   - 实现任务CRUD操作
   - 完成用户管理API
   - 实现AI任务拆解端点

3. 确保数据库正常工作
   - 验证连接配置
   - 测试初始化脚本
   - 执行基本CRUD操作

### 5.2 中期目标（3天内）

1. 完善所有API端点
2. 实现提醒系统
3. 开发日报生成功能
4. 添加基本测试

### 5.3 长期目标（1周内）

1. 优化性能和安全性
2. 完善文档
3. 添加高级功能
4. 实现完整测试覆盖

## 6. 开发指南

### 6.1 环境设置

1. 安装依赖：`pip install -r requirements.txt`
2. 配置环境变量或.env文件
3. 初始化数据库：`python initialize_db.py`
4. 启动开发服务器：`uvicorn main:app --reload`

### 6.2 API文档访问

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### 6.3 代码风格规范

- 遵循PEP 8命名约定
- 使用类型提示
- 添加详细文档字符串
- 保持函数和方法简洁

### 6.4 提交规范

- 遵循语义化提交信息
- 每个提交专注于单一功能或修复
- 提交前运行测试确保代码质量
