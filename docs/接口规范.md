# SmartFlow API接口规范文档

## 通用规范

### 基础URL
```
https://api.smartflow.example.com/api/v1
```

### 认证
所有API（除认证相关端点外）都需要在请求头中包含JWT令牌：
```
Authorization: Bearer {token}
```

### 响应格式
所有API响应均为JSON格式，并包含以下基本结构：
```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "error": null
}
```

### 错误处理
当API发生错误时，将返回以下格式：
```json
{
  "success": false,
  "data": null,
  "message": "错误信息",
  "error": {
    "code": "ERROR_CODE",
    "details": {}
  }
}
```

### HTTP状态码
- 200: 成功
- 201: 创建成功
- 400: 请求错误
- 401: 未授权
- 403: 禁止访问
- 404: 资源不存在
- 422: 验证错误
- 500: 服务器错误

### 分页
列表接口默认支持分页，使用以下请求参数：
```
?page=1&limit=20
```

分页响应格式：
```json
{
  "success": true,
  "data": {
    "items": [],
    "total": 100,
    "page": 1,
    "limit": 20,
    "pages": 5
  },
  "message": "获取成功",
  "error": null
}
```

## 认证API

### 登录
- **URL**: `/auth/login`
- **方法**: `POST`
- **描述**: 用户登录并获取JWT令牌
- **请求体**:
```json
{
  "username": "user@example.com",
  "password": "password123"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "expires_in": 3600,
    "user": {
      "id": 1,
      "username": "user@example.com",
      "full_name": "Test User"
    }
  },
  "message": "登录成功",
  "error": null
}
```

### 刷新令牌
- **URL**: `/auth/refresh`
- **方法**: `POST`
- **描述**: 使用刷新令牌获取新的访问令牌
- **请求体**:
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "expires_in": 3600
  },
  "message": "令牌刷新成功",
  "error": null
}
```

### 密码重置请求
- **URL**: `/auth/password-reset`
- **方法**: `POST`
- **描述**: 请求密码重置链接
- **请求体**:
```json
{
  "email": "user@example.com"
}
```
- **响应**:
```json
{
  "success": true,
  "data": null,
  "message": "如果邮箱存在，重置链接已发送",
  "error": null
}
```

### 密码重置确认
- **URL**: `/auth/password-reset-confirm`
- **方法**: `POST`
- **描述**: 通过令牌确认密码重置
- **请求体**:
```json
{
  "token": "reset-token",
  "new_password": "newPassword123"
}
```
- **响应**:
```json
{
  "success": true,
  "data": null,
  "message": "密码重置成功",
  "error": null
}
```

### 验证令牌
- **URL**: `/auth/verify`
- **方法**: `GET`
- **描述**: 验证令牌是否有效
- **请求头**: `Authorization: Bearer {token}`
- **响应**:
```json
{
  "success": true,
  "data": {
    "user_id": 1,
    "username": "user@example.com"
  },
  "message": "令牌有效",
  "error": null
}
```

## 用户API

### 创建用户
- **URL**: `/users/`
- **方法**: `POST`
- **描述**: 创建新用户
- **权限**: 管理员
- **请求体**:
```json
{
  "username": "newuser@example.com",
  "password": "password123",
  "full_name": "New User",
  "is_active": true
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 2,
    "username": "newuser@example.com",
    "full_name": "New User",
    "is_active": true,
    "created_at": "2023-06-01T12:00:00Z"
  },
  "message": "用户创建成功",
  "error": null
}
```

### 获取当前用户
- **URL**: `/users/me`
- **方法**: `GET`
- **描述**: 获取当前登录用户信息
- **请求头**: `Authorization: Bearer {token}`
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "username": "user@example.com",
    "full_name": "Test User",
    "is_active": true,
    "settings": {},
    "tasks_completed": 5,
    "tasks_created": 10
  },
  "message": "获取成功",
  "error": null
}
```

### 获取特定用户
- **URL**: `/users/{user_id}`
- **方法**: `GET`
- **描述**: 获取特定用户信息
- **权限**: 管理员或本人
- **请求头**: `Authorization: Bearer {token}`
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 2,
    "username": "user2@example.com",
    "full_name": "User Two",
    "is_active": true
  },
  "message": "获取成功",
  "error": null
}
```

### 更新用户
- **URL**: `/users/me`
- **方法**: `PUT`
- **描述**: 更新当前用户信息
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "full_name": "Updated Name",
  "password": "newPassword123"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "username": "user@example.com",
    "full_name": "Updated Name",
    "is_active": true
  },
  "message": "用户信息更新成功",
  "error": null
}
```

### 用户设置
- **URL**: `/users/me/settings`
- **方法**: `GET`/`PUT`
- **描述**: 获取/更新用户设置
- **请求头**: `Authorization: Bearer {token}`
- **PUT请求体**:
```json
{
  "theme": "dark",
  "notifications_enabled": true,
  "language": "zh-CN"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "theme": "dark",
    "notifications_enabled": true,
    "language": "zh-CN"
  },
  "message": "设置已更新",
  "error": null
}
```

### 用户查询
- **URL**: `/users/`
- **方法**: `GET`
- **描述**: 查询用户列表
- **权限**: 管理员
- **请求头**: `Authorization: Bearer {token}`
- **查询参数**: `?search=keyword&page=1&limit=20`
- **响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "username": "user@example.com",
        "full_name": "Test User",
        "is_active": true
      }
    ],
    "total": 1,
    "page": 1,
    "limit": 20,
    "pages": 1
  },
  "message": "获取成功",
  "error": null
}
```

## 任务API

### 创建任务
- **URL**: `/tasks/`
- **方法**: `POST`
- **描述**: 创建新任务
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "title": "完成项目计划",
  "description": "制定详细的项目实施计划",
  "due_date": "2023-07-01T18:00:00Z",
  "priority": "medium",
  "estimated_duration": 120
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "title": "完成项目计划",
    "description": "制定详细的项目实施计划",
    "due_date": "2023-07-01T18:00:00Z",
    "priority": "medium",
    "status": "pending",
    "estimated_duration": 120,
    "importance_score": 0.75,
    "created_at": "2023-06-01T12:00:00Z",
    "owner_id": 1
  },
  "message": "任务创建成功",
  "error": null
}
```

### 获取任务列表
- **URL**: `/tasks/`
- **方法**: `GET`
- **描述**: 获取当前用户的任务列表
- **请求头**: `Authorization: Bearer {token}`
- **查询参数**: `?status=pending&priority=high&page=1&limit=20`
- **响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "title": "完成项目计划",
        "description": "制定详细的项目实施计划",
        "due_date": "2023-07-01T18:00:00Z",
        "priority": "medium",
        "status": "pending",
        "estimated_duration": 120,
        "created_at": "2023-06-01T12:00:00Z"
      }
    ],
    "total": 1,
    "page": 1,
    "limit": 20,
    "pages": 1
  },
  "message": "获取成功",
  "error": null
}
```

### 获取单个任务
- **URL**: `/tasks/{task_id}`
- **方法**: `GET`
- **描述**: 获取特定任务详情
- **请求头**: `Authorization: Bearer {token}`
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "title": "完成项目计划",
    "description": "制定详细的项目实施计划",
    "due_date": "2023-07-01T18:00:00Z",
    "priority": "medium",
    "status": "pending",
    "estimated_duration": 120,
    "importance_score": 0.75,
    "created_at": "2023-06-01T12:00:00Z",
    "updated_at": "2023-06-01T12:00:00Z",
    "owner_id": 1,
    "sub_tasks": [
      {
        "id": 1,
        "title": "收集需求",
        "description": "从各部门收集项目需求",
        "status": "completed",
        "order": 1
      }
    ]
  },
  "message": "获取成功",
  "error": null
}
```

### 更新任务
- **URL**: `/tasks/{task_id}`
- **方法**: `PUT`
- **描述**: 更新特定任务
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "title": "更新项目计划",
  "description": "根据新要求更新项目计划",
  "priority": "high"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "title": "更新项目计划",
    "description": "根据新要求更新项目计划",
    "due_date": "2023-07-01T18:00:00Z",
    "priority": "high",
    "status": "pending",
    "estimated_duration": 120,
    "updated_at": "2023-06-02T10:00:00Z"
  },
  "message": "任务更新成功",
  "error": null
}
```

### 删除任务
- **URL**: `/tasks/{task_id}`
- **方法**: `DELETE`
- **描述**: 删除特定任务
- **请求头**: `Authorization: Bearer {token}`
- **响应**:
```json
{
  "success": true,
  "data": null,
  "message": "任务删除成功",
  "error": null
}
```

### 更新任务状态
- **URL**: `/tasks/{task_id}/status`
- **方法**: `PATCH`
- **描述**: 更新任务状态
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "status": "in_progress"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "status": "in_progress",
    "updated_at": "2023-06-02T11:00:00Z"
  },
  "message": "任务状态更新成功",
  "error": null
}
```

### 创建子任务
- **URL**: `/tasks/{task_id}/subtasks/`
- **方法**: `POST`
- **描述**: 为特定任务创建子任务
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "title": "准备会议材料",
  "description": "为项目启动会准备演示文稿",
  "order": 2
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 2,
    "title": "准备会议材料",
    "description": "为项目启动会准备演示文稿",
    "status": "pending",
    "order": 2,
    "parent_task_id": 1
  },
  "message": "子任务创建成功",
  "error": null
}
```

### 获取子任务列表
- **URL**: `/tasks/{task_id}/subtasks/`
- **方法**: `GET`
- **描述**: 获取特定任务的子任务列表
- **请求头**: `Authorization: Bearer {token}`
- **响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "title": "收集需求",
        "description": "从各部门收集项目需求",
        "status": "completed",
        "order": 1
      },
      {
        "id": 2,
        "title": "准备会议材料",
        "description": "为项目启动会准备演示文稿",
        "status": "pending",
        "order": 2
      }
    ],
    "total": 2
  },
  "message": "获取成功",
  "error": null
}
```

### AI任务拆解
- **URL**: `/tasks/breakdown`
- **方法**: `POST`
- **描述**: 使用AI拆解任务
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "description": "开发一个企业级CRM系统",
  "user_preferences": {
    "detail_level": "high",
    "time_frame": "3_months"
  }
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "main_task": "开发企业级CRM系统",
    "description": "开发一个功能完善的企业客户关系管理系统",
    "estimated_duration": 6480,
    "priority": 8,
    "subtasks": [
      {
        "title": "需求分析与规划",
        "description": "收集并分析客户需求，制定详细的项目计划",
        "order": 1,
        "estimated_duration": 720
      },
      {
        "title": "数据库设计",
        "description": "设计CRM系统的数据库架构",
        "order": 2,
        "estimated_duration": 480
      }
    ]
  },
  "message": "任务拆解成功",
  "error": null
}
```

## 提醒API

### 创建提醒
- **URL**: `/reminders/`
- **方法**: `POST`
- **描述**: 创建新提醒
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "task_id": 1,
  "reminder_time": "2023-06-30T09:00:00Z",
  "message": "项目计划即将截止",
  "priority": 2
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "task_id": 1,
    "reminder_time": "2023-06-30T09:00:00Z",
    "message": "项目计划即将截止",
    "is_sent": false,
    "priority": 2,
    "created_at": "2023-06-01T12:00:00Z"
  },
  "message": "提醒创建成功",
  "error": null
}
```

### 获取提醒列表
- **URL**: `/reminders/`
- **方法**: `GET`
- **描述**: 获取当前用户的提醒列表
- **请求头**: `Authorization: Bearer {token}`
- **查询参数**: `?is_sent=false&page=1&limit=20`
- **响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "task_id": 1,
        "task_title": "完成项目计划",
        "reminder_time": "2023-06-30T09:00:00Z",
        "message": "项目计划即将截止",
        "is_sent": false,
        "priority": 2
      }
    ],
    "total": 1,
    "page": 1,
    "limit": 20,
    "pages": 1
  },
  "message": "获取成功",
  "error": null
}
```

### 按日期获取提醒
- **URL**: `/reminders/date/{date}`
- **方法**: `GET`
- **描述**: 获取特定日期的提醒
- **请求头**: `Authorization: Bearer {token}`
- **响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "task_id": 1,
        "task_title": "完成项目计划",
        "reminder_time": "2023-06-30T09:00:00Z",
        "message": "项目计划即将截止",
        "is_sent": false,
        "priority": 2
      }
    ],
    "total": 1
  },
  "message": "获取成功",
  "error": null
}
```

## 日报API

### 获取日报
- **URL**: `/reports/daily/{date}`
- **方法**: `GET`
- **描述**: 获取特定日期的日报
- **请求头**: `Authorization: Bearer {token}`
- **响应**:
```json
{
  "success": true,
  "data": {
    "date": "2023-06-01",
    "summary": "今天完成了3个任务，进行中2个任务",
    "progress_analysis": "工作效率比昨天提高了15%",
    "deviation_analysis": "任务估时与实际时间偏差在10%以内",
    "optimization_suggestions": "建议优先处理截止日期为本周五的高优先级任务",
    "tasks_completed": 3,
    "tasks_pending": 2,
    "tasks": [
      {
        "id": 1,
        "title": "完成项目计划",
        "status": "completed",
        "completion_time": "2023-06-01T16:30:00Z"
      }
    ]
  },
  "message": "获取成功",
  "error": null
}
```

### 生成日报
- **URL**: `/reports/daily/generate`
- **方法**: `POST`
- **描述**: 生成当前日期的日报
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "date": "2023-06-01"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "report_id": 1,
    "date": "2023-06-01"
  },
  "message": "日报生成成功",
  "error": null
}
```

## 聊天API

### 发送消息
- **URL**: `/chat/messages/`
- **方法**: `POST`
- **描述**: 发送聊天消息
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "content": "大家好，我是新加入的项目经理",
  "message_type": "text"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "content": "大家好，我是新加入的项目经理",
    "message_type": "text",
    "is_system": false,
    "user_id": 1,
    "user_name": "Test User",
    "created_at": "2023-06-01T12:00:00Z"
  },
  "message": "消息发送成功",
  "error": null
}
```

### 获取消息列表
- **URL**: `/chat/messages/`
- **方法**: `GET`
- **描述**: 获取聊天消息列表
- **请求头**: `Authorization: Bearer {token}`
- **查询参数**: `?limit=50&before=message_id`
- **响应**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 2,
        "content": "欢迎加入团队！",
        "message_type": "text",
        "is_system": false,
        "user_id": 2,
        "user_name": "User Two",
        "created_at": "2023-06-01T12:05:00Z"
      },
      {
        "id": 1,
        "content": "大家好，我是新加入的项目经理",
        "message_type": "text",
        "is_system": false,
        "user_id": 1,
        "user_name": "Test User",
        "created_at": "2023-06-01T12:00:00Z"
      }
    ],
    "total": 2
  },
  "message": "获取成功",
  "error": null
}
```

### 分享任务
- **URL**: `/chat/share/task/{task_id}`
- **方法**: `POST`
- **描述**: 在聊天中分享任务
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:
```json
{
  "message": "请大家看下这个任务的进度"
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 3,
    "content": "请大家看下这个任务的进度",
    "message_type": "task_share",
    "is_system": false,
    "user_id": 1,
    "user_name": "Test User",
    "shared_task_id": 1,
    "shared_task": {
      "id": 1,
      "title": "完成项目计划",
      "status": "in_progress"
    },
    "created_at": "2023-06-01T14:00:00Z"
  },
  "message": "任务分享成功",
  "error": null
}
```

## 数据模型参考

### 用户模型
```json
{
  "id": 1,
  "username": "user@example.com",
  "email": "user@example.com",
  "full_name": "Test User",
  "is_active": true,
  "settings": {
    "theme": "light",
    "notifications_enabled": true,
    "language": "zh-CN"
  },
  "tasks_completed": 5,
  "tasks_created": 10,
  "created_at": "2023-01-01T00:00:00Z",
  "updated_at": "2023-06-01T12:00:00Z"
}
```

### 任务模型
```json
{
  "id": 1,
  "title": "完成项目计划",
  "description": "制定详细的项目实施计划",
  "due_date": "2023-07-01T18:00:00Z",
  "priority": "medium",
  "status": "pending",
  "estimated_duration": 120,
  "importance_score": 0.75,
  "owner_id": 1,
  "created_at": "2023-06-01T12:00:00Z",
  "updated_at": "2023-06-01T12:00:00Z"
}
```

### 子任务模型
```json
{
  "id": 1,
  "title": "收集需求",
  "description": "从各部门收集项目需求",
  "status": "pending",
  "order": 1,
  "parent_task_id": 1,
  "created_at": "2023-06-01T12:00:00Z",
  "updated_at": "2023-06-01T12:00:00Z"
}
```

### 提醒模型
```json
{
  "id": 1,
  "task_id": 1,
  "reminder_time": "2023-06-30T09:00:00Z",
  "message": "项目计划即将截止",
  "is_sent": false,
  "priority": 2,
  "created_at": "2023-06-01T12:00:00Z",
  "updated_at": "2023-06-01T12:00:00Z"
}
```

### 日报模型
```json
{
  "id": 1,
  "date": "2023-06-01",
  "user_id": 1,
  "summary": "今天完成了3个任务，进行中2个任务",
  "progress_analysis": "工作效率比昨天提高了15%",
  "deviation_analysis": "任务估时与实际时间偏差在10%以内",
  "optimization_suggestions": "建议优先处理截止日期为本周五的高优先级任务",
  "tasks_completed": 3,
  "tasks_pending": 2,
  "created_at": "2023-06-01T23:00:00Z",
  "updated_at": "2023-06-01T23:00:00Z"
}
```

### 聊天消息模型
```json
{
  "id": 1,
  "content": "大家好，我是新加入的项目经理",
  "message_type": "text",
  "is_system": false,
  "user_id": 1,
  "shared_task_id": null,
  "created_at": "2023-06-01T12:00:00Z"
}
``` 