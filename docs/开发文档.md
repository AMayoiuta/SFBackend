# SmartFlow项目开发文档

## 1. 项目概述

SmartFlow是一个智能任务管理应用，提供AI任务拆解、智能日报分析、提醒系统和社群互动功能。该项目采用前后端分离架构，后端使用Python FastAPI框架，前端基于Flutter构建跨平台移动应用。

## 2. 项目文件架构与说明

### 2.1 后端架构 (Python FastAPI)

#### 2.1.1 根目录文件
- `alembic.ini` - 数据库迁移配置文件
- `initialize_db.py` - 数据库初始化脚本
- `main.py` - 后端应用入口文件

#### 2.1.2 后端核心目录 (smartflow_backend/)
- `alembic.ini` - 数据库迁移配置文件
- `env.example.txt` - 环境变量配置示例
- `requirements.txt` - Python依赖列表
- `main.py` - FastAPI应用入口

##### API模块 (smartflow_backend/api/)
- `v1/api.py` - API路由注册，整合各端点
- `v1/endpoints/auth.py` - 认证相关API端点
- `v1/endpoints/chat.py` - 社群聊天API端点
- `v1/endpoints/reminders.py` - 提醒功能API端点
- `v1/endpoints/reports.py` - 日报功能API端点
- `v1/endpoints/tasks.py` - 任务管理API端点
- `v1/endpoints/users.py` - 用户管理API端点

##### 核心模块 (smartflow_backend/core/)
- `ai_services/task_breakdown.py` - AI任务拆解服务
- `auth/__init__.py` - 认证模块初始化文件
- `auth/deps.py` - 认证依赖项，用于路由保护
- `auth/jwt.py` - JWT令牌处理
- `auth/password.py` - 密码处理工具
- `config.py` - 应用配置管理

##### 数据库模块 (smartflow_backend/db/)
- `base.py` - 数据库基类，定义表公共属性
- `models.py` - SQLAlchemy数据模型
- `session.py` - 数据库会话管理

##### 迁移脚本 (smartflow_backend/migrations/)
- `env.py` - Alembic环境配置
- `script.py.mako` - Alembic脚本模板
- `versions/` - 迁移版本脚本

### 2.2 前端架构 (Flutter)

#### 2.2.1 Flutter基础文件
- `smartflow_frontend/pubspec.yaml` - Flutter项目配置和依赖管理
- `smartflow_frontend/analysis_options.yaml` - 静态分析配置

#### 2.2.2 前端核心目录 (smartflow_frontend/)
- `assets/` - 图片、字体等静态资源
- `test/` - 单元测试和组件测试

##### 主要代码目录 (smartflow_frontend/lib/)
- `main.dart` - 应用程序入口
- `app.dart` - 应用程序配置和启动

###### 模型 (smartflow_frontend/lib/models/)
- `task.dart` - 任务数据模型
- `subtask.dart` - 子任务数据模型
- `user.dart` - 用户数据模型
- `report.dart` - 日报数据模型
- `reminder.dart` - 提醒数据模型
- `chat_message.dart` - 聊天消息模型

###### 服务 (smartflow_frontend/lib/services/)
- `api_service.dart` - API服务基类
- `auth_service.dart` - 认证服务
- `task_service.dart` - 任务服务
- `report_service.dart` - 日报服务
- `reminder_service.dart` - 提醒服务
- `chat_service.dart` - 聊天服务
- `local_storage_service.dart` - 本地存储服务

###### 屏幕/页面 (smartflow_frontend/lib/screens/)
- `auth/login_screen.dart` - 登录界面
- `auth/register_screen.dart` - 注册界面
- `auth/forgot_password_screen.dart` - 忘记密码界面
- `tasks/task_list_screen.dart` - 任务列表界面
- `tasks/task_detail_screen.dart` - 任务详情界面
- `tasks/task_create_screen.dart` - 创建任务界面
- `reports/daily_report_screen.dart` - 日报界面
- `reminders/reminder_list_screen.dart` - 提醒列表界面
- `chat/chat_screen.dart` - 聊天界面
- `profile/user_profile_screen.dart` - 用户资料界面
- `settings/settings_screen.dart` - 应用设置界面

###### 组件 (smartflow_frontend/lib/widgets/)
- `task/task_card.dart` - 任务卡片组件
- `task/task_form.dart` - 任务表单组件
- `task/subtask_item.dart` - 子任务项组件
- `report/report_chart.dart` - 报告图表组件
- `common/custom_button.dart` - 自定义按钮
- `common/custom_text_field.dart` - 自定义文本输入框
- `common/loading_indicator.dart` - 加载指示器

###### 工具 (smartflow_frontend/lib/utils/)
- `date_formatter.dart` - 日期格式化工具
- `validators.dart` - 表单验证工具
- `constants.dart` - 应用常量
- `theme.dart` - 应用主题

###### 状态管理 (smartflow_frontend/lib/providers/)
- `auth_provider.dart` - 认证状态提供者
- `task_provider.dart` - 任务状态提供者
- `report_provider.dart` - 报告状态提供者
- `settings_provider.dart` - 设置状态提供者

###### 路由 (smartflow_frontend/lib/routes/)
- `app_router.dart` - 应用路由配置

## 3. 开发任务分配

### 3.1 后端开发者A：认证系统与用户管理

#### 认证系统实现
- **文件**：`smartflow_backend/core/auth/jwt.py`
- **实现内容**：
  - JWT令牌生成函数（create_access_token, create_refresh_token）
  - 令牌验证函数（verify_token）
  - 令牌解码函数（decode_token）
  - 令牌过期处理

#### 密码管理工具
- **文件**：`smartflow_backend/core/auth/password.py`
- **实现内容**：
  - 密码哈希函数（get_password_hash）
  - 密码验证函数（verify_password）
  - 密码强度检查函数（check_password_strength）

#### 认证依赖项
- **文件**：`smartflow_backend/core/auth/deps.py`
- **实现内容**：
  - 当前用户依赖项（get_current_user）
  - 活跃用户依赖项（get_current_active_user）
  - 可选用户依赖项（get_optional_user）
  - 管理员用户依赖项（get_current_admin_user）

#### 用户API端点
- **文件**：`smartflow_backend/api/v1/endpoints/users.py`
- **实现内容**：
  - 创建用户API（POST /users/）
  - 读取用户API（GET /users/me, GET /users/{user_id}）
  - 更新用户API（PUT /users/me）
  - 用户设置API（GET/PUT /users/me/settings）
  - 用户查询API（GET /users/）

#### 认证API端点
- **文件**：`smartflow_backend/api/v1/endpoints/auth.py`
- **实现内容**：
  - 登录API（POST /auth/login）
  - 刷新令牌API（POST /auth/refresh）
  - 密码重置请求API（POST /auth/password-reset）
  - 密码重置确认API（POST /auth/password-reset-confirm）
  - 验证令牌API（GET /auth/verify）

#### 数据库模型完善
- **文件**：`smartflow_backend/db/models.py`
- **实现内容**：
  - 完善用户模型（User）属性和关系
  - 添加审计字段（created_at, updated_at）
  - 添加密码重置模型（PasswordReset）
  - 优化数据库索引和约束

### 3.2 后端开发者B：任务管理与AI服务集成

#### 任务管理API
- **文件**：`smartflow_backend/api/v1/endpoints/tasks.py`
- **实现内容**：
  - 创建任务API（POST /tasks/）
  - 获取任务API（GET /tasks/, GET /tasks/{task_id}）
  - 更新任务API（PUT /tasks/{task_id}）
  - 删除任务API（DELETE /tasks/{task_id}）
  - 任务状态更新API（PATCH /tasks/{task_id}/status）
  - 子任务管理API（POST/GET/PUT/DELETE /tasks/{task_id}/subtasks/）
  - 任务日志API（POST/GET /tasks/{task_id}/logs/）
  - AI任务拆解API（POST /tasks/breakdown）

#### AI任务拆解服务
- **文件**：`smartflow_backend/core/ai_services/task_breakdown.py`
- **实现内容**：
  - 完善AI模型调用逻辑
  - 添加错误重试机制
  - 实现提示词优化
  - 添加响应缓存机制
  - 实现结果格式化和验证
  - 添加用户偏好定制功能

#### 提醒系统
- **文件**：`smartflow_backend/api/v1/endpoints/reminders.py`
- **实现内容**：
  - 创建提醒API（POST /reminders/）
  - 获取提醒API（GET /reminders/, GET /reminders/{reminder_id}）
  - 更新提醒API（PUT /reminders/{reminder_id}）
  - 删除提醒API（DELETE /reminders/{reminder_id}）
  - 标记提醒为已发送API（PATCH /reminders/{reminder_id}/sent）
  - 按日期获取提醒API（GET /reminders/date/{date}）

#### 日报系统
- **文件**：`smartflow_backend/api/v1/endpoints/reports.py`
- **实现内容**：
  - 获取日报API（GET /reports/daily/{date}）
  - 生成日报API（POST /reports/daily/generate）
  - 日报统计API（GET /reports/stats/{start_date}/{end_date}）
  - 进度分析API（GET /reports/progress/{task_id}）
  - 导出日报API（GET /reports/daily/{date}/export）

#### 聊天系统
- **文件**：`smartflow_backend/api/v1/endpoints/chat.py`
- **实现内容**：
  - 发送消息API（POST /chat/messages/）
  - 获取消息API（GET /chat/messages/）
  - 分享任务API（POST /chat/share/task/{task_id}）
  - 获取系统通知API（GET /chat/notifications/）

#### 应用配置管理
- **文件**：`smartflow_backend/core/config.py`
- **实现内容**：
  - 环境变量加载和验证
  - 应用配置类（Settings）
  - 不同环境配置（开发、测试、生产）
  - AI服务配置
  - 数据库配置

### 3.3 全栈开发者A：前端架构与任务UI

#### 前端项目架构
- **文件**：
  - `smartflow_frontend/lib/main.dart`
  - `smartflow_frontend/lib/app.dart`
  - `smartflow_frontend/pubspec.yaml`
- **实现内容**：
  - 应用入口和初始化
  - 主题配置和国际化
  - 路由系统设置
  - 依赖包管理和配置

#### API服务实现
- **文件**：
  - `smartflow_frontend/lib/services/api_service.dart`
  - `smartflow_frontend/lib/services/task_service.dart`
  - `smartflow_frontend/lib/services/auth_service.dart`
- **实现内容**：
  - HTTP客户端封装
  - 请求拦截器实现（添加认证头）
  - 响应处理和错误管理
  - 任务相关API调用实现
  - 认证相关API调用实现

#### 任务模型实现
- **文件**：
  - `smartflow_frontend/lib/models/task.dart`
  - `smartflow_frontend/lib/models/subtask.dart`
- **实现内容**：
  - 完善任务模型属性
  - 实现fromJson和toJson方法
  - 添加辅助方法（计算进度、状态转换等）
  - 添加子任务关联处理

#### 任务列表界面
- **文件**：`smartflow_frontend/lib/screens/tasks/task_list_screen.dart`
- **实现内容**：
  - 任务列表展示（按优先级/状态分组）
  - 筛选和排序功能
  - 拖拽排序功能
  - 添加/编辑/删除任务入口
  - 下拉刷新和无限滚动

#### 任务详情界面
- **文件**：`smartflow_frontend/lib/screens/tasks/task_detail_screen.dart`
- **实现内容**：
  - 任务详情展示
  - 子任务管理（添加/编辑/删除/完成）
  - 任务状态更新
  - 任务日志记录
  - 提醒设置
  - 任务分享功能

#### 任务创建/编辑界面
- **文件**：`smartflow_frontend/lib/screens/tasks/task_create_screen.dart`
- **实现内容**：
  - 任务表单实现
  - 表单验证
  - 日期选择器
  - 优先级选择
  - AI任务拆解集成
  - 文件上传功能

#### 任务组件
- **文件**：
  - `smartflow_frontend/lib/widgets/task/task_card.dart`
  - `smartflow_frontend/lib/widgets/task/task_form.dart`
  - `smartflow_frontend/lib/widgets/task/subtask_item.dart`
- **实现内容**：
  - 任务卡片UI实现
  - 任务表单组件实现
  - 子任务项组件实现
  - 任务进度指示器实现

#### 任务状态管理
- **文件**：`smartflow_frontend/lib/providers/task_provider.dart`
- **实现内容**：
  - 任务状态管理（创建/更新/删除）
  - 子任务状态管理
  - 任务筛选逻辑
  - 任务排序逻辑
  - 本地缓存集成

### 3.4 全栈开发者B：用户体验与分析UI

#### 认证界面实现
- **文件**：
  - `smartflow_frontend/lib/screens/auth/login_screen.dart`
  - `smartflow_frontend/lib/screens/auth/register_screen.dart`
  - `smartflow_frontend/lib/screens/auth/forgot_password_screen.dart`
- **实现内容**：
  - 登录表单UI和验证
  - 注册表单UI和验证
  - 忘记密码流程
  - 表单状态管理
  - 错误处理和提示

#### 用户资料与设置界面
- **文件**：
  - `smartflow_frontend/lib/screens/profile/user_profile_screen.dart`
  - `smartflow_frontend/lib/screens/settings/settings_screen.dart`
- **实现内容**：
  - 用户资料展示和编辑
  - 应用设置（主题、语言、通知等）
  - 用户统计信息展示
  - 密码更改功能
  - 注销功能

#### 日报界面实现
- **文件**：`smartflow_frontend/lib/screens/reports/daily_report_screen.dart`
- **实现内容**：
  - 日报数据展示
  - 统计图表集成
  - 任务完成率展示
  - 偏差分析展示
  - 优化建议展示
  - 导出功能

#### 提醒界面实现
- **文件**：`smartflow_frontend/lib/screens/reminders/reminder_list_screen.dart`
- **实现内容**：
  - 提醒列表展示
  - 提醒创建和编辑
  - 提醒通知集成
  - 按优先级分类展示
  - 提醒状态管理

#### 聊天界面实现
- **文件**：`smartflow_frontend/lib/screens/chat/chat_screen.dart`
- **实现内容**：
  - 聊天消息列表
  - 消息发送功能
  - 任务分享功能
  - 系统通知展示
  - 消息类型处理（文本/图片/任务分享）

#### UI组件库开发
- **文件**：`smartflow_frontend/lib/widgets/common/`
- **实现内容**：
  - 自定义按钮组件
  - 自定义输入框组件
  - 加载指示器组件
  - 错误提示组件
  - 空状态组件
  - 确认对话框组件
  - 自定义卡片组件

#### 报表组件开发
- **文件**：`smartflow_frontend/lib/widgets/report/report_chart.dart`
- **实现内容**：
  - 任务完成率图表
  - 时间利用率图表
  - 进度对比图表
  - 优先级分布图表
  - 历史趋势图表

#### 本地存储服务
- **文件**：`smartflow_frontend/lib/services/local_storage_service.dart`
- **实现内容**：
  - 用户偏好存储
  - 令牌缓存
  - 任务缓存
  - 离线数据同步

#### 应用主题与样式
- **文件**：`smartflow_frontend/lib/utils/theme.dart`
- **实现内容**：
  - 亮色/暗色主题配置
  - 颜色方案定义
  - 文本样式定义
  - 组件样式定义
  - 响应式布局支持

#### 路由配置
- **文件**：`smartflow_frontend/lib/routes/app_router.dart`
- **实现内容**：
  - 路由定义和配置
  - 路由守卫实现（认证检查）
  - 路由动画配置
  - 深链接支持
  - 404页面配置

## 4. 开发规范

### 4.1 代码风格规范
- Python：遵循PEP 8规范
- Dart：遵循官方Dart风格指南
- 文件命名：使用蛇形命名法（snake_case）
- 类命名：使用大驼峰命名法（PascalCase）
- 函数/变量命名：使用小驼峰或蛇形命名法（根据语言规范）

### 4.2 注释规范
- 所有公共API必须添加文档字符串
- 复杂算法需添加详细注释
- 使用TODO、FIXME标记待完成或问题代码
- 类和方法需说明功能、参数和返回值

### 4.3 测试要求
- 后端API端点必须有单元测试
- 前端关键组件必须有组件测试
- 核心业务逻辑必须有测试覆盖
- 必须包含正向和异常测试用例

### 4.4 提交规范
- 提交信息格式：`[模块]: 描述`（如`[auth]: 添加密码重置功能`）
- 单次提交应聚焦单一功能或修复
- 提交前必须通过代码检查和测试

## 5. 协作流程

### 5.1 Git工作流
- 主分支：`main`（稳定版本）
- 开发分支：`dev`（集成测试）
- 功能分支：`feature/xxx`（单功能开发）
- 修复分支：`bugfix/xxx`（问题修复）

### 5.2 代码审查流程
- 所有合并请求必须经过至少一人审查
- 确保通过所有自动化测试
- 遵循商定的代码规范
- 确保功能实现完整

### 5.3 冲突解决策略
- 优先进行代码重构避免冲突
- 使用结对编程解决复杂冲突
- 定期合并主分支到功能分支，避免长期分叉

## 6. 技术要点

### 6.1 后端技术栈
- Python 3.9+
- FastAPI
- SQLAlchemy
- Alembic
- Pydantic
- Python-Jose (JWT)
- Passlib (密码哈希)

### 6.2 前端技术栈
- Dart 2.15+
- Flutter 3.0+
- Provider (状态管理)
- Http (网络请求)
- Shared Preferences (本地存储)
- FL Chart (图表)
- Intl (国际化)

### 6.3 开发工具
- IDE：VS Code / Android Studio
- API测试：Postman / Insomnia
- 版本控制：Git
- 持续集成：GitHub Actions

## 7. 交付标准

### 7.1 代码质量
- 零编译警告
- 通过静态代码分析
- 测试覆盖率 ≥ 80%
- 无已知漏洞

### 7.2 性能指标
- API响应时间 < 300ms
- 应用启动时间 < 2s
- 页面切换时间 < 100ms
- 内存占用 < 100MB

### 7.3 文档要求
- API文档（OpenAPI/Swagger）
- 架构文档
- 部署文档
- 用户使用手册
